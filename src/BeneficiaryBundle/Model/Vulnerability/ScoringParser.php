<?php

namespace BeneficiaryBundle\Model\Vulnerability;

use BeneficiaryBundle\Exception\CsvParserException;
use BeneficiaryBundle\Exception\ScoringCsvException;
use BeneficiaryBundle\Model\AbstractCsvParser;

class ScoringParser extends AbstractCsvParser
{
    private const CONDITION_COLUMN = 'condition_enum';
    private const CONDITION_VALUE_COLUMN = 'value_of_condition';
    private const SCORE_COLUMN = 'score';

    /**
     * @param string $pathToCsv
     *
     * @return ScoringValueObject
     *
     * @throws CsvParserException|ScoringCsvException
     */
    public function parse(string $pathToCsv): ScoringValueObject
    {
        $this->mandatoryColumns = [self::CONDITION_COLUMN, self::CONDITION_VALUE_COLUMN, self::SCORE_COLUMN];

        $csv = $this->readCsvToArray($pathToCsv);

        $scoringValueObject = new ScoringValueObject();

        foreach ($csv as $row) {
            if ($this->rowEmpty($row)) {
                continue;
            }

            $this->checkRow($row);

            $scoringValueObject->setScore($row[self::CONDITION_COLUMN], (int) $row[self::SCORE_COLUMN]);

            if (in_array($row[self::CONDITION_COLUMN], ConditionEnum::withValue())) {
                $scoringValueObject->setConditionValue($row[self::CONDITION_COLUMN], (int) $row[self::CONDITION_VALUE_COLUMN]);
            }
        }

        $scoringValueObject->validate();

        return $scoringValueObject;
    }

    /**
     * @param $row
     *
     * @throws ScoringCsvException
     */
    private function checkRow($row): void
    {
        if (!in_array($row[self::CONDITION_COLUMN], ConditionEnum::all())) {
            throw new ScoringCsvException($row[self::CONDITION_COLUMN], 'Unknown condition');
        }

        if (0 === strlen($row[self::SCORE_COLUMN])) {
            throw new ScoringCsvException($row[self::CONDITION_COLUMN], 'Missing score value');
        }

        if (!is_numeric($row[self::SCORE_COLUMN])) {
            throw new ScoringCsvException($row[self::CONDITION_COLUMN], 'Bad format score value');
        }

        if (in_array($row[self::CONDITION_COLUMN], ConditionEnum::withValue())) {
            if (0 === strlen($row[self::CONDITION_VALUE_COLUMN])) {
                throw new ScoringCsvException($row[self::CONDITION_COLUMN], 'Missing condition value');
            }

            if (!is_numeric($row[self::CONDITION_VALUE_COLUMN])) {
                throw new ScoringCsvException($row[self::CONDITION_COLUMN], 'Bad format condition value');
            }
        }
    }
}
